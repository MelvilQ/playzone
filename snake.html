<head>
	<title>Snake</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-icon" href="./favicon.ico">
</head>

<body style="background-color: black; text-align: center; user-select: none">

<div style="color: white; font-family: courier; font-size: 20px">Score: <span id="score">0</span></div>

<canvas width="500" height="500" id="gameCanvas"></canvas>

<script>

window.onload = function(){
	isMobile = 
	initModel();
	initScreen();
}

function update(){
	updateModel();
	updateScreen();
}

function initModel(){
	snake = [{x:12,y:5}, {x:12,y:4}, {x:12,y:3}];
	dir = "down";
	food = {x:3,y:3};
	score = 0;
	gameOver = false;
}

function initScreen(){
	canvas = document.getElementById("gameCanvas");
	context = canvas.getContext("2d");
	if (screen.width < 500) {
		canvas.width = 300;
		canvas.height = 300;
		squareSize = 12;
		isMobile = true;
		document.getElementById('manual').innerHTML = 'Touch to play.'
	} else {
		squareSize = 20;
	}
	window.addEventListener('keydown', handleKeyDown);
	canvas.addEventListener('click', handleClick);
	setInterval(update, 1000/12);
}

function handleKeyDown(e){
	if(e.keyCode == 37 && dir != "right") dir = "left";
	else if(e.keyCode == 38 && dir != "down") dir = "up";
	else if(e.keyCode == 39 && dir != "left") dir = "right";
	else if(e.keyCode == 40 && dir != "up") dir = "down";
}

function handleClick(event){
	if(gameOver){
		initModel();
	} else {
		const click = {
			x: Math.floor((event.offsetX-1) / squareSize),
			y: Math.floor((event.offsetY-1) / squareSize)
		};
		const diff = {
			x: snake[0].x - click.x,
			y: snake[0].y - click.y
		};
		if (diff.x !== 0 && dir !== 'left' && dir !== 'right'){
			dir = diff.x > 0 ? 'left' : 'right';
		} else if(diff.y !== 0 && dir !== 'up' && dir !== 'down') {
			dir = diff.y > 0 ? 'up' : 'down';
		}
	}
}

function updateModel(){
	if(gameOver) return;
	// perform one step forward
	front = snake[0];
	if(dir == "down") snake.unshift({x: front.x, y: front.y + 1});
	else if(dir == "up") snake.unshift({x: front.x, y: front.y - 1});
	else if(dir == "left") snake.unshift({x: front.x - 1, y: front.y});
	else if(dir == "right") snake.unshift({x: front.x + 1, y: front.y});
	// check collision
	collision = false;
	front = snake[0];
	if(front.x <= -1 || front.y <= -1 || front.x >= 25 || front.y >= 25)
		collision = true;
	snake.forEach(function(part){
		if(part != front && part.x == front.x && part.y == front.y)
			collision = true;
	});
	if(collision)
		gameOver = true;
	// check food
	if(snake[0].x == food.x && snake[0].y == food.y){
		score += 1;
		// place new food (but not onto the snake)
		food = null;
		while(food == null){
			food = {x: randomIntBetween(0, 24), y: randomIntBetween(0, 24)};
			for (i=0; i<snake.length; ++i){
				part = snake[i];
				if(part.x == food.x && part.y == food.y){
					food = null;
					break;
				}
			}
		}
	} else {
		// remove last part
		snake.pop();
	}
}

function updateScreen(){
	// draw background
	context.fillStyle = "black";
	context.fillRect(0, 0, canvas.width, canvas.height);
	context.strokeStyle = "yellow";
	context.lineWidth = 5;
	context.strokeRect(0, 0, canvas.width, canvas.height);
	// draw snake
	context.fillStyle = "darkslategrey";
	part = snake[0];
	context.fillRect(squareSize*part.x + 1, squareSize*part.y + 1, squareSize - 2, squareSize - 2);
	context.fillStyle = "green";
	for (i=1; i<snake.length; ++i){
		part = snake[i];
		context.fillRect(squareSize*part.x + 1, squareSize*part.y + 1, squareSize - 2, squareSize - 2);
	}
	// draw food
	context.fillStyle = "dodgerblue";
	context.fillRect(squareSize*food.x + 3, squareSize*food.y + 3, squareSize - 6, squareSize - 6);
	// draw game over text
	if(gameOver){
		if (isMobile) {
			context.font = "40px Courier"
			context.fillStyle = "red";
			context.fillText("GAME OVER", 40, 160);
			context.font = "20px Courier";
			context.fillText("Click to restart", 50, 200);
		} else {
			context.font = "60px Courier"
			context.fillStyle = "red";
			context.fillText("GAME OVER", 90, 270);
			context.font = "30px Courier";
			context.fillText("Click to restart", 110, 310);
		}
	}
	// update score
	document.getElementById("score").innerHTML = score;
}

function randomIntBetween(start, end){
	return Math.floor(Math.random()*(end-start+1)) + start;
}

</script>

<div id="manual" style="color: white; font-family: courier; font-size: 12px; margin-top: 3px">Use arrow keys to play.</div>

</body>
